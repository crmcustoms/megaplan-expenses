# Megaplan Expenses Application

–í–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É —Ä–æ–∑—Ö–æ–¥—ñ–≤ –ø—Ä–æ–µ–∫—Ç—É –∑ Megaplan CRM.

## üéØ –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å

- ‚úÖ –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∑ 16 –∫–æ–ª–æ–Ω–∫–∞–º–∏ —Ä–æ–∑—Ö–æ–¥—ñ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø—ñ–¥—Å—É–º–∫–æ–≤–æ—ó —Å—É–º–∏
- ‚úÖ –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel (CSV –∑ UTF-8 BOM)
- ‚úÖ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Megaplan —á–µ—Ä–µ–∑ API
- ‚úÖ –í–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –≤ –∫–∞—Ä—Ç–∫—É —É–≥–æ–¥–∏ —á–µ—Ä–µ–∑ "–í–Ω–µ—à–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫"
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π –¥–∏–∑–∞–π–Ω
- ‚úÖ –ö–æ–ª—å–æ—Ä–æ–≤—ñ —Å—Ç–∞—Ç—É—Å-—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### 1. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
# –ö–ª–æ–Ω—É–≤–∞—Ç–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
git clone <repository-url>
cd megaplan-expenses

# –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
npm install
```

### 2. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤—ñ `.env.example`:

```bash
cp .env.example .env
```

–í—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ `.env` —ñ –≤–∫–∞–∑–∞—Ç–∏ —Å–≤–æ—ó credentials Megaplan:

```env
MEGAPLAN_ACCOUNT=your-account
MEGAPLAN_LOGIN=api_user
MEGAPLAN_PASSWORD=api_password
```

### 3. –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ

```bash
# Production mode
npm start

# Development mode (–∑ auto-reload)
npm run dev
```

–í—ñ–¥–∫—Ä–∏—Ç–∏ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ: `http://localhost:3000?dealId=12345`

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
megaplan-expenses/
‚îú‚îÄ‚îÄ index.html              # –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ styles.css          # –°—Ç–∏–ª—ñ
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îî‚îÄ‚îÄ app.js              # Frontend –ª–æ–≥—ñ–∫–∞
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ expenses.js         # API: –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–æ–∑—Ö–æ–¥—ñ–≤
‚îÇ   ‚îî‚îÄ‚îÄ export.js           # API: –µ–∫—Å–ø–æ—Ä—Ç CSV
‚îú‚îÄ‚îÄ server.js               # Express —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ package.json            # –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
‚îú‚îÄ‚îÄ .env.example            # –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
‚îî‚îÄ‚îÄ README.md               # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
```

## üîß API Endpoints

### GET /api/expenses?dealId={dealId}

–û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ —Ä–æ–∑—Ö–æ–¥–∏ –ø–æ —É–≥–æ–¥—ñ.

**Request:**
```
GET /api/expenses?dealId=18899
```

**Response:**
```json
{
  "dealId": 18899,
  "dealName": "Logitech Campaign",
  "expenses": [
    {
      "deal_id": 18899,
      "status": "–û–ø–ª–∞—á–µ–Ω–æ",
      "category": "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥",
      "brand": "Logitech",
      ...
    }
  ],
  "total": 286000.00
}
```

### GET /api/export?dealId={dealId}

–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ä–æ–∑—Ö–æ–¥–∏ –≤ CSV.

**Request:**
```
GET /api/export?dealId=18899
```

**Response:**
```
Content-Type: text/csv; charset=utf-8
Content-Disposition: attachment; filename="expenses_18899_2026-02-09.csv"

[CSV content with UTF-8 BOM]
```

### GET /api/health

–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É —Å–µ—Ä–≤–µ—Ä–∞.

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2026-02-09T10:00:00.000Z"
}
```

## üîå –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Megaplan

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ–ª—è "–í–Ω–µ—à–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫"

1. –í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ö–µ–º–∏ —É–≥–æ–¥ –≤ Megaplan
2. –î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ —Ç–∏–ø—É "–í–Ω–µ—à–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫"
3. –í–∫–∞–∑–∞—Ç–∏ URL:

```
https://your-domain.com/index.html?dealId={{id}}
```

Megaplan –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç—å `{{id}}` = ID –ø–æ—Ç–æ—á–Ω–æ—ó —É–≥–æ–¥–∏.

### –ú–∞–ø–ø—ñ–Ω–≥ –∫–∞—Å—Ç–æ–º–Ω–∏—Ö –ø–æ–ª—ñ–≤

–í `.env` —Ñ–∞–π–ª—ñ –≤–∫–∞–∑–∞—Ç–∏ ID –∫–∞—Å—Ç–æ–º–Ω–∏—Ö –ø–æ–ª—ñ–≤ –∑ Megaplan:

```env
FIELD_STATUS=1001
FIELD_CATEGORY=1002
FIELD_BRAND=1003
...
```

–©–æ–± –∑–Ω–∞–π—Ç–∏ ID –ø–æ–ª—ñ–≤:
1. –í—ñ–¥–∫—Ä–∏—Ç–∏ Megaplan API Console
2. –ó—Ä–æ–±–∏—Ç–∏ –∑–∞–ø–∏—Ç: `GET /api/v3/task/{taskId}`
3. –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `customFields`

## üåê Deployment

### Vercel (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

1. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Vercel CLI:
```bash
npm i -g vercel
```

2. Deploy:
```bash
vercel
```

3. –î–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è –≤ Vercel Dashboard:
   - MEGAPLAN_ACCOUNT
   - MEGAPLAN_LOGIN
   - MEGAPLAN_PASSWORD

### Netlify

1. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Netlify CLI:
```bash
npm i -g netlify-cli
```

2. Deploy:
```bash
netlify deploy --prod
```

### VPS / Beget

1. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ FTP/SSH

2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
```bash
npm install --production
```

3. –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ PM2:
```bash
npm install -g pm2
pm2 start server.js --name megaplan-expenses
pm2 save
pm2 startup
```

4. –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ Nginx (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):
```nginx
location /expenses {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}
```

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Deal not found"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π dealId –∞–±–æ –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —É–≥–æ–¥–∏.

**–†—ñ—à–µ–Ω–Ω—è:** 
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ dealId –≤ URL
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É API –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

### –ü—Ä–æ–±–ª–µ–º–∞: "CORS Error"

**–ü—Ä–∏—á–∏–Ω–∞:** –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫—É—î –∑–∞–ø–∏—Ç–∏ —á–µ—Ä–µ–∑ CORS.

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥–¥–∞—î CORS headers
- –î–æ–¥–∞—Ç–∏ –¥–æ–º–µ–Ω –≤ CORS whitelist

### –ü—Ä–æ–±–ª–µ–º–∞: CSV –∑ –∫—Ä—è–∫–æ–∑—è–±—Ä–∞–º–∏

**–ü—Ä–∏—á–∏–Ω–∞:** Excel –Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤ –∫–æ–¥—É–≤–∞–Ω–Ω—è.

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ CSV –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ UTF-8 BOM (`\uFEFF`)
- –í—ñ–¥–∫—Ä–∏—Ç–∏ CSV —á–µ—Ä–µ–∑ "–Ü–º–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö" –≤ Excel

### –ü—Ä–æ–±–ª–µ–º–∞: "Unauthorized"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ credentials Megaplan.

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ MEGAPLAN_LOGIN —Ç–∞ MEGAPLAN_PASSWORD –≤ `.env`
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ API –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É

## üìä –¢–∞–±–ª–∏—Ü—è –∑ 16 –∫–æ–ª–æ–Ω–∫–∞–º–∏

| ‚Ññ | –ö–æ–ª–æ–Ω–∫–∞ | –û–ø–∏—Å |
|---|---------|------|
| 1 | deal_id | ID —É–≥–æ–¥–∏ |
| 2 | –°—Ç–∞—Ç—É—Å | –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂—É |
| 3 | –°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–æ–≤ | –ö–∞—Ç–µ–≥–æ—Ä—ñ—è |
| 4 | –ë—Ä–µ–Ω–¥ | –ë—Ä–µ–Ω–¥ —Ç–æ–≤–∞—Ä—É |
| 5 | –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç | –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ |
| 6 | –¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞ | –°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏ |
| 7 | –ú–µ–Ω–µ–¥–∂–µ—Ä | –í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π |
| 8 | –°—É–º–º–∞ | –ë–∞–∑–æ–≤–∞ —Å—É–º–∞ |
| 9 | –î–æ–ø.—Å—Ç–æ–∏–º–æ—Å—Ç—å | –î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏ |
| 10 | –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å | –ü—ñ–¥—Å—É–º–∫–æ–≤–∞ —Å—É–º–∞ |
| 11 | –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å | –†–µ–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å |
| 12 | –°—É—Ç—å | –û–ø–∏—Å |
| 13 | –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–¥–µ–ª–∫—É | –ü–æ—Å–∏–ª–∞–Ω–Ω—è |
| 14 | –°–æ–∑–¥–∞—Ç–µ–ª—å | –ê–≤—Ç–æ—Ä –∑–∞–ø–∏—Å—É |
| 15 | –í–∞–ª—é—Ç–∞ | –ö–æ–¥ –≤–∞–ª—é—Ç–∏ |
| 16 | deal_name | –ù–∞–∑–≤–∞ —É–≥–æ–¥–∏ |

## üîê –ë–µ–∑–ø–µ–∫–∞

- ‚úÖ API credentials –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `.env` (–Ω–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó)
- ‚úÖ Basic Auth –¥–ª—è Megaplan API
- ‚úÖ CORS –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
- ‚úÖ Input validation
- ‚úÖ Error handling

**–í–ê–ñ–õ–ò–í–û:** –ù—ñ–∫–æ–ª–∏ –Ω–µ –∫–æ–º—ñ—Ç—å—Ç–µ `.env` —Ñ–∞–π–ª –≤ git!

–î–æ–¥–∞—Ç–∏ –≤ `.gitignore`:
```
.env
node_modules/
```

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–ü–∏—Ç–∞–Ω–Ω—è —Ç–∞ –ø—Ä–æ–±–ª–µ–º–∏: [—Å—Ç–≤–æ—Ä–∏—Ç–∏ issue](https://github.com/your-repo/issues)

## üìù –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT License

---

**–°—Ç–≤–æ—Ä–µ–Ω–æ –∑ ‚ù§Ô∏è –¥–ª—è CRM Customs**
